name: ðŸ”„ Proses Artikel

on:
  push:
    branches: ['main']
    # Pastikan path ini sesuai dengan file yang ingin Anda proses.
    # Saya asumsikan file yang akan diproses berada di 'artikel/*.html'
    paths:
      - 'artikel/*.html'
  workflow_dispatch:

permissions:
  # Diperlukan untuk checkout dan push kembali perubahan
  contents: write

jobs:
  process_articles:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 diperlukan untuk commit/push dan operasi git lainnya
          fetch-depth: 0

      # HAPUS: Langkah Cache Perl sebelumnya (karena Setup Perl menonaktifkan cache modul)

      # 2. Setup Perl
      # Gunakan v2 untuk versi yang lebih baru dan support cache yang lebih baik (meski di nonaktifkan)
      - name: Setup Perl 5.36
        uses: shogo82148/actions-setup-perl@v1.30.0
        with:
          perl-version: '5.36'
          # Menonaktifkan cache modul untuk menghindari WARNING 400
          enable-modules-cache: false

      # 3. Localize Assets
      - name: Localize Assets (gantifontshighlight.pl)
        run: |
          set -euo pipefail
          # Cek keberadaan file, jika tidak ada, skip atau exit 1
          [[ -f ext/gantifontshighlight.pl ]] || { echo "ext/gantifontshighlight.pl tidak ditemukan! Lewati langkah ini."; exit 0; }
          # Hanya perlu menjalankan jika file ditemukan
          chmod +x ext/gantifontshighlight.pl
          perl ext/gantifontshighlight.pl --quiet --no-backup

      # 4. Replace Content (TANPA \)
      - name: Replace Content (Perl Sed)
        run: |
          set -euo pipefail
          # Menggunakan file di 'artikel/*.html' sesuai dengan trigger
          shopt -s nullglob
          for file in artikel/*.html; do
            [[ -f "$file" ]] || continue
            echo "Memproses $file"
            perl -i -wpe '
              s|bak[.]xo[.]je|frijal.pages.dev|g;
              s|https://frijal[.]pages[.]dev/assets/apple-touch-icon[.]png|https://frijal.pages.dev/ext/icons/apple-touch-icon.png|g;
              s|hhttps://frijal[.]pages[.]dev/apple-touch-icon[.]png|https://frijal.pages.dev/ext/icons/apple-touch-icon.png|g;
              s|frijal_tw|frijal|g;
              s|YOUR_FACEBOOK_APP_ID|1471267430691023|g;
              s|nama_twitter_anda|frijal|g;
              s|akun_twitter_kamu|frijal|g;
              s|&copy;|ðŸ„¯|g;
              s|Â©|ðŸ„¯|g;
            ' "$file"
          done
          shopt -u nullglob

      # 5. Commit dan Push Perubahan
      # Ini akan menyimpan kembali file yang telah diubah oleh Perl
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # Hanya commit file yang diubah
          commit_message: "ðŸ¤– Proses Artikel: Perubahan Otomatis"
          branch: main # Atau branch target Anda
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
          commit_author: GitHub Actions Bot <actions@github.com>
          # File/direktori yang dicommit (sesuaikan jika perlu)
          file_pattern: 'artikel/'
