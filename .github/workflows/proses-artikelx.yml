name: ðŸ”„ Proses ArtikelX

on:
  push:
    branches: ['main']
    paths:
      - 'artikelx/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_articles:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      # 3. Setup Perl (NONAKTIFKAN CPAN CACHE)
      - name: Setup Perl
        uses: shogo82148/actions-setup-perl@v1.35.0
        with:
          perl-version: '5.42'
          enable-modules-cache: false   # INI HILANGKAN WARNING 400

      # 5. Localize Assets
      - name: Localize Assets (gantifontshighlight.pl)
        run: |
          set -euo pipefail
          [[ -f ext/gantifontshighlight.pl ]] || { echo "ext/gantifontshighlight.pl tidak ditemukan!"; exit 1; }
          chmod +x ext/gantifontshighlight.pl
          perl ext/gantifontshighlight.pl --quiet --no-backup

      # 6. Replace Content (TANPA \ SAMA SEKALI)
      - name: Replace Content (no backslash)
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            [[ -f "$file" ]] || continue
            echo "Memproses $file"
            perl -i -wpe '
              s|</head>|<meta name="google-adsense-account" content="ca-pub-8157928740123992"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8157928740123992" crossorigin="anonymous"></script></head>|g;
              s|https://dalam[.]web[.]id/assets/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;
              s|https://dalam[.]web[.]id/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;
              s|frijal_tw|frijal|g;
              s|YOUR_FACEBOOK_APP_ID|1471267430691023|g;
              s|nama_twitter_anda|frijal|g;
              s|akun_twitter_kamu|frijal|g;
              s|YourTwitterHandle|frijal|g;
              s|&copy;|ðŸ„¯|g;
              s|Â©|ðŸ„¯|g;
            ' "$file"
          done
          shopt -u nullglob

      # 7. Inject Meta via JS
      - name: Inject Meta via JS
        run: |
          set -euo pipefail
          if [[ -f ext/inject-meta.js ]]; then
            node --version && node ext/inject-meta.js || echo "Gagal jalankan inject-meta.js"
          else
            echo "ext/inject-meta.js tidak ada, dilewati."
          fi

      # 8. Add HTML Elements (SED INLINE, TIDAK ADA \)
      - name: Add HTML Elements
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            [[ -f "$file" ]] || continue
            echo "Menambahkan elemen ke $file"

            # 1. CSS + RSS
            if ! grep -q '<link rel="stylesheet" href="/ext/marquee-url.css">' "$file"; then
              sed -i '/<\/head>/i <link rel="stylesheet" href="/ext/marquee-url.css"><link rel="alternate" type="application/rss+xml" title="30 artikel baru bikin." href="https://dalam.web.id/rss.xml" />' "$file"
            fi

            # 2. div iposbrowser
            if ! grep -q '<div id="iposbrowser"></div>' "$file"; then
              sed -i '/<\/h1>/a <div id="iposbrowser"></div>' "$file"
            fi

            # 3. floating search
            if ! grep -q 'class="search-floating-container"' "$file"; then
              sed -i '/<\/body>/i <div class="search-floating-container"><input type="text" id="floatingSearchInput" placeholder="cari artikel..." autocomplete="off"><span id="floatingSearchClear" class="clear-button"></span><div id="floatingSearchResults" class="floating-results-container"></div></div>' "$file"
            fi

            # 4. related marquee
            if ! grep -q 'id="related-marquee-section"' "$file"; then
              sed -i '/<\/body>/i <section id="related-marquee-section"><div id="related-marquee-container"></div></section><script defer src="/ext/marquee-url.js"></script>' "$file"
            fi

            # 5. JS scripts
            if ! grep -q '/ext/iposbrowser.js' "$file"; then
              sed -i '/<\/body>/i <script defer src="/ext/iposbrowser.js"></script><script defer src="/ext/markdown.js"></script><script defer src="/ext/pesbukdiskus.js"></script>' "$file"
            fi
          done
          shopt -u nullglob

      # 9. Move to artikel/
      - name: Move to artikel/
        run: |
          set -euo pipefail
          mkdir -p artikel
          shopt -s nullglob
          files=(artikelx/*.html)
          shopt -u nullglob

          if [[ ${#files[@]} -eq 0 ]]; then
            echo "Tidak ada file HTML di artikelx/"
            exit 0
          fi

          mv -f "${files[@]}" artikel/
          echo "Berhasil pindahkan ${#files[@]} file ke artikel/"

      # 10. Commit & Push
      - name: Commit & Push Changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add artikelx artikel

          if git diff --staged --quiet; then
            echo "Tidak ada perubahan untuk dikomit."
            exit 0
          fi

          git commit -m "Proses ArtikelX: localize + enrich HTML"
          git push origin main
          echo "Perubahan berhasil dikirim!"
