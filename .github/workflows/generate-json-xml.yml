name: â˜¢ï¸ Build and Generate Site Files

on:
  # â¬‡ï¸ Pemicu 1 Berjalan jika ada push ke main yang mengubah *.html di artikel/
  push:
    branches: ['main']
    paths:
      - 'artikel/*.html' # Pemicu ini diaktifkan kembali

  # â¬‡ï¸ Pemicu 2 Berjalan setelah Workflow 'Proses ArtikelX' selesai
  workflow_run:
    workflows: ["ğŸ”„ Proses ArtikelX"] # Pastikan NAMA workflow pertama SAMA PERSIS
    types:
      - completed # Hanya berjalan jika workflow pertama SELESAI
    branches: ['main'] # Hanya berjalan jika workflow pertama dijalankan di branch main

  # â¬‡ï¸ Pemicu 3 & 4: Manual dan Terjadwal (tetap ada)
  workflow_dispatch:  # Untuk menjalankan manual
  schedule:           # Untuk menjalankan terjadwal
    - cron: '0 20 * * *'  

jobs:
  build:
    runs-on: ubuntu-latest    
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4
        with:
          # Pastikan mengambil commit terbaru
          ref: ${{ github.ref }} 
          fetch-depth: 0 

      - name: '2. Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: '3. Install Dependencies'
        run: npm ci

      - name: '4. Generate artikel.json, sitemap.xml & RSS'
        run: |
          echo "ğŸ“ Generating site files..."
          node ext/generator.js
          node ext/rss.js
        env:
          RSS_LIMIT: 30

      - name: '5. Generate Sitemap Rekursif & Tambahkan URL Statis'
        run: |
          echo "ğŸ“ Memulai pembuatan sitemap.txt yang lengkap dan rekursif..."
          BASE_URL="https://dalam.web.id"
          SITEMAP_FILE="sitemap.txt"
          # 1. GUNAKAN FIND UNTUK ARTIKEL (Membuat file baru/overwrite menggunakan operator >)
          # Mencari semua file .html di artikel/ dan sub-direktori, hapus ekstensi (.html), tambahkan BASE_URL.
          find artikel/ -name "*.html" | \
          sed 's_\.html$__' | \
          sed "s_^_$BASE_URL/_" > $SITEMAP_FILE
          echo "Artikel rekursif dari artikel/ telah ditambahkan ke $SITEMAP_FILE."          
          # 2. GUNAKAN ECHO UNTUK URL STATIS (Menambahkan ke file yang sudah ada/append menggunakan operator >>)
          echo "ğŸ”„ Menambahkan URL halaman statis..."          
          # URL Statis yang Ditemukan (URL yang seharusnya memiliki file .html di root)
          echo "$BASE_URL/" >> $SITEMAP_FILE # Halaman utama (index.html)
          echo "$BASE_URL/search" >> $SITEMAP_FILE
          echo "$BASE_URL/disclaimer" >> $SITEMAP_FILE
          echo "$BASE_URL/feed" >> $SITEMAP_FILE
          echo "$BASE_URL/img" >> $SITEMAP_FILE
          echo "$BASE_URL/sitemap" >> $SITEMAP_FILE
          echo "$BASE_URL/data-deletion-form" >> $SITEMAP_FILE
          echo "$BASE_URL/data-deletion" >> $SITEMAP_FILE
          echo "âœ… Semua URL statis telah ditambahkan."

      - name: '6. Generate screenshots'
        run: |
          echo "ğŸ“¸ Generating screenshots (installing puppeteer)..."
          # Gunakan cache npm jika memungkinkan untuk puppeteer
          npm install puppeteer --no-save --cache .npm-cache --prefer-offline
          echo "Running screenshot script..."
          node ext/screenshot-puppeteer.js          
        
      - name: '7. Commit and Push All Generated Files'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Tidak ada perubahan file yang di-generate, tidak perlu commit."
            # Jika dipicu oleh push, kita tidak ingin menghentikan workflow di sini
            # karena mungkin langkah deploy selanjutnya perlu berjalan meskipun file generated tidak berubah.
            # Jika dipicu oleh workflow_run/schedule/dispatch dan tidak ada perubahan, aman untuk keluar.
            if [[ "${{ github.event_name }}" != "push" ]]; then
              exit 0 
            else
              echo "Workflow dipicu oleh push, melanjutkan meskipun tidak ada file generated baru."
            fi
          fi

          # Hanya commit jika ada perubahan yang di-stage
          if ! git diff --staged --quiet; then
            echo "â³ Perubahan ditemukan. Melakukan commit..."
            git commit -m "build: ğŸš€ img, html, txt & json udah beres."

            echo "ğŸ”ƒ Melakukan sinkronisasi sebelum push..."
            git pull --rebase origin main || { echo "âš ï¸ Gagal pull --rebase, mencoba push biasa"; git pull origin main; }
            
            echo "ğŸš€ Mendorong perubahan ke server..."
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: '8. Show Published Links & Summary'
        if: always() 
        run: |
          echo "--- Summary ---"
          echo "âœ… File yang seharusnya di-generate:"
          echo "ğŸ”— artikel.json: https://dalam.web.id/artikel.json"
          echo "ğŸ”— sitemap.xml : https://dalam.web.id/sitemap.xml"
          echo "ğŸ”— rss.xml     : https://dalam.web.id/rss.xml"
          echo "ğŸ”— sitemap.txt : https://dalam.web.id/sitemap.txt" # <-- DITAMBAHKAN DI SINI
          echo "ğŸ“Š Jumlah konten saat ini:"
          COUNTHTML=$(ls artikel/*.html 2>/dev/null | wc -l || echo 0)
          echo "â¡ï¸  $COUNTHTML artikel (*.html) di folder artikel/"
          COUNTWEBP=$(ls img/*.webp 2>/dev/null | wc -l || echo 0)
          echo "â¡ï¸  $COUNTWEBP cover (*.webp) di folder img/"
          # Tampilkan info pemicu
          echo "Triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          fi
