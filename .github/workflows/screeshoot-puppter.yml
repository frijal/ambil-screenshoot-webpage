name: üì∏ Generate Screenshots (External Domain)

# üì¢ Pemicu Workflow
# Menggantikan schedule/dispatch dengan trigger yang Anda inginkan (misalnya, push ke main)
on:
  workflow_dispatch:
  # Anda bisa menambahkan schedule: jika diperlukan
  
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    
    # üö® PENTING: Berikan izin 'write' agar 'git push' berhasil (Solusi Error 403)
    permissions:
      contents: write

    env:
      NODE_VERSION: 20.x

    steps:
      - name: ‚öôÔ∏è 1. Checkout Kode
        uses: actions/checkout@v6

      - name: üõ†Ô∏è 2. Setup Node.js dan Install Dependencies
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ 3. Install NPM dependencies
        run: npm install

      - name: üåê 4. Ensure Puppeteer Chromium is installed
        # Menggantikan apt-get yang lambat dengan perintah yang disarankan Puppeteer
        run: npx puppeteer install

      # Jika ada langkah 5 (misal: generate html/json), letakkan di sini.

      - name: '6. Generate screenshots'
        run: |
          echo "üì∏ Generating screenshots (installing puppeteer)..."
          # Karena npm install sudah dilakukan di langkah 3, ini hanya menjalankan skrip
          echo "Running screenshot script..."
          # Pastikan path ke skrip sesuai dengan yang Anda inginkan
          node ext/screenshot-puppeteer.js 
        env:
          # Pastikan file Anda ada di sini, jika perlu token untuk domain luar
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 

      - name: '7. Commit and Push All Generated Files'
        run: |
          # üö® Pastikan folder img/ dan artikel/ sudah ada di root folder.
          
          # Konfigurasi Git User
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage semua file yang mungkin berubah atau baru dibuat
          # Termasuk img/ (webp), artikel/ (txt/html jika di-generate), dll.
          git add img/ artikel/
          
          # Cek apakah ada perubahan yang di-stage
          if git diff --staged --quiet; then
            echo "‚úÖ Tidak ada perubahan file yang di-generate, tidak perlu commit."
            
            # Logika yang Anda inginkan untuk 'push' trigger
            if [[ "${{ github.event_name }}" != "push" ]]; then
              exit 0 
            else
              echo "Workflow dipicu oleh push, melanjutkan meskipun tidak ada file generated baru."
            fi
            
          else
            # Hanya commit jika ada perubahan yang di-stage
            echo "‚è≥ Perubahan ditemukan. Melakukan commit..."
            git commit -m "build: üöÄ img, html, txt & json udah beres. [skip ci]" # Menambahkan [skip ci] untuk mencegah loop

            echo "üîÉ Melakukan sinkronisasi sebelum push..."
            # Pull --rebase lebih aman untuk CI
            # Gunakan --allow-unrelated-histories jika Anda yakin
            git pull --rebase origin main || { echo "‚ö†Ô∏è Gagal pull --rebase, mencoba pull biasa"; git pull origin main; }
            
            echo "üöÄ Mendorong perubahan ke server..."
            git push origin main
          fi
        env:
          # Token GITHUB_TOKEN diperlukan oleh git push
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          
      - name: '8. Show Published Links & Summary'
        if: always() 
        run: |
          echo "--- Summary ---"
          echo "‚úÖ File yang seharusnya di-generate:"
          echo "üîó artikel.json: https://dalam.web.id/artikel.json"
          echo "üîó sitemap.xml : https://dalam.web.id/sitemap.xml"
          echo "üîó rss.xml     : https://dalam.web.id/rss.xml"
          echo "üîó sitemap.txt : https://dalam.web.id/sitemap.txt"
          
          echo "üìä Jumlah konten saat ini:"
          # Menggunakan bash globbing dengan safe exit jika file tidak ada
          COUNTHTML=$(ls -f artikel/*.html 2>/dev/null | wc -l || echo 0)
          echo "‚û°Ô∏è  $COUNTHTML artikel (*.html) di folder artikel/"
          COUNTWEBP=$(ls -f img/*.webp 2>/dev/null | wc -l || echo 0)
          echo "‚û°Ô∏è  $COUNTWEBP cover (*.webp) di folder img/"
          
          echo "Triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          fi
