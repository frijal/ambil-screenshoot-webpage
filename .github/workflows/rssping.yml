name: ü§ñ Ping Feeds, Sitemap, & Generate LLMs.txt

on:
  workflow_dispatch:  # Bisa dijalankan manual
  schedule:
    # Otomatis tiap hari jam 06:00 UTC (sekitar jam 14:00 WITA)
    - cron: "0 6 * * *" 

jobs:
  generate_index:
    # Job ini berfungsi untuk membuat file llms.txt dan memastikan nama penulisnya benar
    runs-on: ubuntu-latest
    permissions:
      contents: write # Izin untuk commit/push

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      # Tidak ada instalasi dependencies, karena skrip hanya menggunakan modul bawaan (ringan!)
      
      - name: ‚öôÔ∏è Run LLMs Index generation script
        # Pastikan ini adalah path yang benar ke generate_llms.py kamu
        run: python ext/generate_llms.py

      - name: üíæ Commit and Push generated files
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add llms.txt llms.md llms-index.html
          
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan pada llms.txt. Melewati commit."
          else
            echo "Ada perubahan. Committing dan pushing..."
            git commit -m "ü§ñ Docs: Auto-generate llms.txt index"
            git push
            echo "‚úÖ Commit dan Push sukses!"
          fi

  ping:
    # Job ini bergantung pada Job 'generate_index' (agar proses file sudah selesai sebelum ping, jika ada perubahan)
    needs: generate_index 
    runs-on: ubuntu-latest
    
    steps:
      - name: üîî Ping Feeds ke Ping-o-Matic
        run: |
          BASE_URL="https://dalam.web.id"
          BLOG_TITLE="Layar Kosong"
          FEEDS=(
            "feed-catatan-and-opini-sosial.xml"
            "feed-kuliner-gaya-hidup-and-kesehatan.xml"
            "feed-lainnya.xml"
            "feed-linux-and-open-source.xml"
            "feed-multimedia-and-editing.xml"
            "feed-sejarah-and-religi.xml"
            "feed-teknologi-web-ai-and-umum.xml"
            "rss.xml"
          )
          echo "--- Pinging Ping-o-Matic for ${#FEEDS[@]} feeds ---"
          for feed_file in "${FEEDS[@]}"; do
            FEED_URL="$BASE_URL/$feed_file"
            echo "Pinging: $FEED_URL"
            # Kirim request POST ke Ping-o-Matic
            curl -s -o /dev/null -X POST \
              --data-urlencode "title=$BLOG_TITLE" \
              --data-urlencode "blogurl=$BASE_URL/" \
              --data-urlencode "rssurl=$FEED_URL" \
              https://pingomatic.com/ping/
          done
          echo "--- Ping-o-Matic Pings Sent ---"

      - name: üìç Ping Sitemap & Main RSS ke Google & Bing
        run: |
          BASE_URL="https://dalam.web.id"
          SITEMAP_URL="$BASE_URL/sitemap.xml"
          RSS_URL="$BASE_URL/rss.xml"        
          echo "--- Pinging Bing Yandex ---"
          echo "Pinging Sitemap: $SITEMAP_URL"
          curl -s "https://www.bing.com/ping?sitemap=$SITEMAP_URL"
          echo "Pinging RSS Feed: $RSS_URL"
          curl -s "https://www.bing.com/ping?sitemap=$RSS_URL"          
          echo "--- Google - Bing - Yandex Pings Sent ---"
