name: Generate Layar Kosong AI API (Manual/Scheduled)

on:
  workflow_dispatch:
  schedule:
    # 0 19 * * * (Jadwal ini berarti pukul 19:00 UTC, atau 03:00 WITA)
    - cron: "0 19 * * *" 

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      # Membutuhkan write permission untuk langkah commit
      contents: write
      
    steps:
    - name: 1. Checkout Repository Code
      uses: actions/checkout@v4
      with:
        # Token harus disetel agar push ke branch yang sama diperbolehkan
        token: ${{ secrets.GITHUB_TOKEN }}
        # Fetch-depth 0 diperlukan jika Anda ingin melakukan pull/rebase yang andal
        fetch-depth: 0 

    - name: 2. Setup Node.js Environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm' 

    # 3. Instal Dependencies (@google/genai, cheerio, dll.)
    - name: 3. Install Node Dependencies
      run: npm install 

    # 4. Jalankan Skrip API Generator (Script sudah Async + Gemini)
    - name: 4. Run AI API Generator Script
      # Kita kirimkan GEMINI_API_KEY ke skrip Node.js sebagai environment variable
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEY1: ${{ secrets.GEMINI_API_KEY1 }}
        GEMINI_API_KEY2: ${{ secrets.GEMINI_API_KEY2 }}
        GEMINI_API_KEY3: ${{ secrets.GEMINI_API_KEY3 }}
        GEMINI_API_KEY4: ${{ secrets.GEMINI_API_KEY4 }}
        GEMINI_API_KEY5: ${{ secrets.GEMINI_API_KEY5 }}
        GEMINI_API_KEY6: ${{ secrets.GEMINI_API_KEY6 }}
        GEMINI_API_KEY7: ${{ secrets.GEMINI_API_KEY7 }}
          # Kamu bisa daftar sampai KEY20 di sini, 
          # kalau di Secrets kosong, script akan otomatis mengabaikannya.
      run: node ext/generate-ai-api.js 

    # 5. COMMIT DAN PUSH FILE JSON YANG BARU DIBUAT (MENGGANTIKAN ACTION EKSTERNAL)
    - name: 5. Commit & Push Generated API Files (Native Git)
      run: |
        # 1. Konfigurasi Bot
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 2. Stage HANYA folder api/v1/
        git add api/v1/
        
        # 3. Pengecekan Perubahan (Optimasi: Cek apakah ada yang di-stage)
        if git diff --staged --quiet; then
          echo "‚úÖ Tidak ada perubahan yang ditemukan di api/v1/. Commit dilewati."
          exit 0
        fi
        
        # 4. Commit dan Push
        echo "‚è≥ Perubahan ditemukan di api/v1/. Melakukan commit..."
        
        # Commit
        git commit -m "build(ci): ü§ñ Generate and update AI API files"
        
        # Sinkronisasi (Opsional, tapi dianjurkan untuk mencegah push rejected)
        echo "üîÉ Melakukan sinkronisasi sebelum push..."
        git pull --rebase origin main || { 
          echo "‚ö†Ô∏è Gagal pull --rebase, mencoba pull biasa"; 
          git pull origin main; 
        }
        
        # Push
        echo "üöÄ Mendorong perubahan ke server..."
        git push origin main
      env:
        # GITHUB_TOKEN tidak perlu disetel eksplisit di sini karena sudah ada di 'with: token:' di langkah 1,
        # dan actions/checkout@v4 sudah menggunakan GITHUB_TOKEN secara default,
        # tetapi menyediakannya di sini terkadang lebih eksplisit.
        # Catatan: Variabel GITHUB_TOKEN bersifat otomatis dan sudah diizinkan oleh permissions: write.
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
